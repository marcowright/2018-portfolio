#!/bin/bash

# Set build folder
BF=./.build

# Remove .build folder
rm -rf ${BF}

# Create a client build
meteor-build-client ${BF} -p ''

# Remove stats file
rm -f ${BF}/*.stats.json

# Get name of autogenerated js file
JS=$(basename $(ls ${BF}/*.js) .js)

# Get name of autogenerated css file
CSS=$(basename $(ls ${BF}/*.css) .css)

# If we found a js name
if [[ "${JS}" != '' ]]; then
  # Replace name of js script to app.js
  mv ${BF}/${JS}.js ${BF}/app.js

  # Make a copy of the asset gzipped
  gzip -k ${BF}/app.js

  # Make sed regex for replacement in files
  SREG=s/${JS}/app/

  # Replace src of script tag in index.html
  sed -i '' -e ${SREG} ${BF}/index.html
fi

# If we found a css name
if [[ "${CSS}" != '' ]]; then
  # Replace name of js script to app.js
  mv ${BF}/${CSS}.css ${BF}/style.css

  # Make a copy of the asset gzipped
  gzip -k ${BF}/style.css

  # Make sed regex for replacement in files
  SREG=s/${CSS}/style/

  # Replace src of script tag in index.html
  sed -i '' -e ${SREG} ${BF}/index.html
fi

# Line Feed with 8 chars of space
LFWSP=$'\n        '

# Add char encoding right after head tag
sed -i '' -e "s#<head>#<head>\\$lf<meta charset='utf-8'>#" ${BF}/index.html

# Fix permissions
chmod -R 655 ${BF}/*
